name: Build and push
on:
  push:
    branches:
      - "*"
  workflow_dispatch:
    inputs:
      publish:
        description: Publish
        type: choice
        options:
          - varnish-cache
          - orca-chart
          - varnish-enterprise

jobs:
  build_and_push:
    strategy:
      matrix:
        chart:
          - varnish-cache
          - orca-chart
          - varnish-enterprise
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: "Install system dependencies"
        run: |
          curl -sL https://get.helm.sh/helm-v3.19.0-linux-amd64.tar.gz -o /tmp/helm.tar.gz
          tar xavf /tmp/helm.tar.gz
          mv linux-amd64/helm /usr/local/bin/helm

          pip install yq

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends bats parallel
      - name: "Add Helm dependencies"
        # See also: https://circleci.com/docs/env-vars/#alpine-linux
        run: |
            cd ${{ matrix.chart }}
            # Helm is painful https://github.com/helm/helm/issues/8036
            i=0
            yq -r '.dependencies[]?.repository' < Chart.yaml | while read -r p; do
              i=$((i+1))
              helm repo add dep$i "$p"
            done
            helm dependency build
      - name: "Unit tests"
        run: |
          ${{ matrix.chart }}/test/unit_common/run.sh -j $(( $(nproc) * 4))
      - name: Create package
        run: |
          helm package "${{ matrix.chart }}"
          mkdir -p /tmp/artifacts
          cp "${{ matrix.chart }}"-*.tgz /tmp/artifacts
      - name: "Push chart"
        if: ${{ github.event.inputs.publish == matrix.chart }}
        run: |
          echo ${{ secrets.DOCKERHUB_TOKEN }} | helm registry login -u "varnish" --password-stdin registry-1.docker.io
          helm push "${{ matrix.chart }}"-*.tgz "oci://registry-1.docker.io/varnish"
      - name: "Upload artifact package"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.chart }}
          path: ${{ matrix.chart }}-*.tgz
          if-no-files-found: error

  packagecloud:
    needs: 
      - build_and_push
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart:
          - varnish-enterprise
    steps:
      - name: Download artifact package
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.package_dir }}
          path: ${{ matrix.package_dir }}
      - name: Find
        run: |
          find . -ls
      - name: "Push chart to packagecloud"
        if: ${{ github.event.inputs.publish == matrix.chart }}
        uses: computology/packagecloud-github-action@v0.8
        with:
          package-name: ${{ matrix.chart }}/*.tgz
          packagecloud-distro: helm/v1
          packagecloud-username: varnishplus
          packagecloud-reponame: helm-staging
          packagecloud-token: ${{ secrets.PACKAGECLOUD_TOKEN }}
